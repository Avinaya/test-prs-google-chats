---
name: PR Creation Tracker
on:
  pull_request:
    types:
      - opened
    branches:
      - main
jobs:
  labeler:
    runs-on: ubuntu-latest
    name: Label the PR size
    outputs:
      step_output: ${{ steps.set_pr_size.outputs.pr_size }}
    steps:
      - name: PR Size Labeler
        id: set_pr_size
        uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: size/xs
          xs_max_size: "10"
          s_label: size/s
          s_max_size: "100"
          m_label: size/m
          m_max_size: "500"
          l_label: size/l
          l_max_size: "1000"
          xl_label: size/xl
          fail_if_xl: "false"
          message_if_xl: >
            This PR exceeds the recommended size of 1000 lines. Please make
            sure you are NOT addressing multiple issues with one PR. Note this
            PR might be rejected due to its size.
          github_api_url: api.github.com
          files_to_ignore: ""
  build:
    runs-on: ubuntu-latest
    needs: labeler
    steps:
      - name: Extract PR Size from Logs
        id: extract_pr_size
        run: >
          pr_size=$(echo "${{ needs.labeler.outputs.step_output }}" | grep -oP 'Final
          labels: "size/(\w+)"' | sed 's/Final labels: "size\///')

          echo "::set-output name=pr_size::$pr_size"
      - name: Git PR Details
        run: >
          pr_creator="${{ github.event.pull_request.user.login }}"

          pr_title="${{ github.event.pull_request.title }}"

          pr_number="${{ github.event.pull_request.number }}"

          pr_url="${{ github.event.pull_request.html_url }}"

          pr_body="${{ github.event.pull_request.body }}"

          pr_labels="$(echo "${{ join(github.event.pull_request.labels.*.name) }}" | sed 's/ /, /g')"

          pr_assignees="$(echo "${{ join(github.event.pull_request.assignees.*.login) }}" | sed 's/ /, /g')"


          pr_size="${{ needs.extract_pr_size.outputs.pr_size }}"


          curl --location --request POST "${{ secrets.PR_WEBHOOK_SECRET }}" \

          --header 'Content-Type: application/json' \

          --data-raw "{
              \"cards\": [
                {
                  \"header\": {
                    \"title\": \"üè¥‚Äç‚ò†Ô∏è Ahoy there!\",
                    \"subtitle\": \"A new pull request has just been opened by ü•π $pr_creator with size $pr_size.\"
                  },
                  \"sections\": [
                    {
                      \"widgets\": [
                        {
                          \"keyValue\": {
                            \"topLabel\": \"üëâ\",
                            \"content\": \"$pr_title\"
                          }
                        },
                        {
                          \"keyValue\": {
                            \"topLabel\": \"üîó\",
                            \"content\": \"$pr_url\"
                          }
                        }
                      ]
                    },
                    {
                      \"textParagraph\": \"$pr_body\"
                    }
                  ]
                }
              ]
          }"
        env:
          PR_WEBHOOK_SECRET: ${{ secrets.PR_WEBHOOK_SECRET }}
